# High Availability Environment Template
# Maximized for resilience and uptime
# Use when the proxy must maintain availability even during backend failures

# === Core Proxy Settings ===
# Adequate workers for redundancy
Workers=20
# Large queue to handle failover scenarios
MaxQueueLength=30
# Extended timeout for retries and failover (25 minutes)
Timeout=1500000
# Frequent polling for health monitoring
PollInterval=10000
PollTimeout=2000

# === Priority & Queue Management ===
# Standard priority levels with redundancy focus
DefaultPriority=2
PriorityKeyHeader=S7PPriorityKey
PriorityKeys=critical,high,normal
PriorityValues=0,1,2
# Balanced allocation with focus on critical requests
PriorityWorkers=0:8,1:8,2:4

# === Backend Configuration ===
# Use multiple backends across regions for high availability
LoadBalanceMode=latency
# Required: Set your backend hosts across different regions/zones
# Host1=https://your-backend-region1.example.com
# Host2=https://your-backend-region2.example.com
# Host3=https://your-backend-region3.example.com
# Host4=https://your-backup-region.example.com
# Probe_path1=/health
# Probe_path2=/health  
# Probe_path3=/health
# Probe_path4=/health

# === Connection Settings ===
# Robust connection settings for high availability
KeepAliveInitialDelaySecs=45
KeepAlivePingIntervalSecs=45
KeepAliveIdleTimeoutSecs=900
# Enable multiple connections for redundancy
EnableMultipleHttp2Connections=true
MultiConnLifetimeSecs=5400
MultiConnIdleTimeoutSecs=450
MultiConnMaxConns=6000

# === Circuit Breaker (Conservative for HA) ===
# Conservative circuit breaker to avoid unnecessary failovers
CBErrorThreshold=30
CBTimeslice=45
SuccessRate=90

# === Async Operations (Enabled with redundancy) ===
AsyncModeEnabled=true
AsyncTimeout=2100000
AsyncTriggerTimeout=15000
# Enable async storage for durability
AsyncBlobStorageUseMI=true
AsyncSBUseMI=true

# === Storage & Database (Enabled with redundancy) ===
StorageDbEnabled=true
StorageDbContainerName=Requests

# === Authentication (Enabled for security) ===
UseOAuth=false
UseOAuthGov=false
ValidateAuthAppID=true
UseProfiles=true

# === Logging (Comprehensive for monitoring) ===
# Enhanced logging for monitoring and troubleshooting
LogConsole=true
LogConsoleEvent=true
LogAllRequestHeaders=false
LogAllResponseHeaders=false
LogPoller=true
LogProbes=true
# Log important headers for troubleshooting
LogHeaders=X-Request-ID,X-Correlation-ID

# === Header Management ===
# Comprehensive header management for HA
RequiredHeaders=X-Request-ID
DisallowedHeaders=
StripResponseHeaders=
ValidateHeaders=
TimeoutHeader=S7PTimeout
TTLHeader=S7PTTL

# === Response Settings ===
AcceptableStatusCodes=200,202,401,403,404,408,410,412,417,400
DefaultTTLSecs=450

# === User Management (Enhanced) ===
UserIDFieldName=userId
UniqueUserHeaders=X-UserID,X-Client-ID
UserPriorityThreshold=0.05

# === Container Settings ===
RequestIDPrefix=S7P-HA
S7P_EnableHealthMonitoring=true
S7P_EnableDiagnosticProfiling=true

# High Availability Settings
S7P_PreferClosestRegion=true
S7P_ActiveActiveFailover=true
S7P_BackendHealthCheckThreshold=80
S7P_LoadBalancingStrategy=RoundRobin