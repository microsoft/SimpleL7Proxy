<!--
	- Policies are applied in the order they appear.
	- Position <base/> inside a section to inherit policies from the outer scope.
	- Comments within policies are not preserved.
-->
<!-- Add policies as children to the <inbound>, <outbound>, <backend>, and <on-error> elements -->
<policies>
	<!-- Throttle, authorize, validate, cache, or transform the requests, return 408, 429 on timeout and concurrency limits, error body on 400 -->
	<!-- Policy Date: 11/26/2025 -->
	<inbound>
		<base />
		<cache-lookup-value key="@("listBackends-" + context.Api.Id)" variable-name="listBackends" />
		<!-- set the request ID in case we need to debug with OpenAI Service -->
		<set-header name="x-ms-client-request-id" exists-action="override">
			<value>@(context.Request.Headers.GetValueOrDefault("x-S7P-id", Guid.NewGuid().ToString()))</value>
		</set-header>
		<!-- Check if the response is in cache -->
		<!-- If we can't find the variable, initialize it -->
		<set-variable name="priorityCfg" value="@{
			// Create a JObject for priority configuration
			JObject cfg = new JObject();
			cfg["1"] = new JObject { { "retryCount", 1 }, { "requeue", false  } };
			cfg["2"] = new JObject { { "retryCount", 1  }, { "requeue", false } };
			cfg["3"] = new JObject { { "retryCount", 1  }, { "requeue", false  } };
			return cfg;
		}" />
		<set-variable name="priorityHeaderName" value="llm_proxy_priority" />
		<set-variable name="PolicyCycleCounterHeaderName" value="x-PolicyCycleCounter" />
		<set-variable name="AffinityHeaderName" value="x-backend-affinity" />
		<choose>
			<when condition="@(context.Variables.ContainsKey("listBackends") == false)">
				<set-variable name="listBackends" value="@{
					JArray backends = new JArray();
					string salt = "0123456789"; // 10-digit salt
					
					//backends.Add(new JObject()
				   // {
					//	{ "url", "https://nvmopenai3.openai.azure.com/" },
					//	{ "priority", 1},
					//	{ "ModelType", "PTU" },
					//	{ "acceptablePriorities", new JArray(1,2,3) },
					//	{ "LimitConcurrency", "off"},
					//	{ "BufferResponse" , true},
					//  { "Timeout" , 300},
					//	{ "api-key", ""}
					//});
					backends.Add(new JObject()
					{
						{ "url", "https://a208790-function-app-sleep-gvdha0ffczd4h4cc.eastus2-01.azurewebsites.net/api/sleep_function?loc=1" },
						{ "priority", 1},
						{ "ModelType", "PAYGO" },
						{ "acceptablePriorities", new JArray(1,2,3) }, // Acceptable priorities for this backend
						{ "LimitConcurrency", "off"},
						{ "BufferResponse" , true},
						{ "Timeout" , 10},
						{ "api-key", ""}
					});
					backends.Add(new JObject()
					{
						{ "url", "https://nvm2.openai.azure.com/" },
						{ "priority", 2},
						{ "ModelType", "PAYGO" },
						{ "acceptablePriorities", new JArray(1,2,3) }, // Acceptable priorities for this backend
						{ "LimitConcurrency", "off"},
						{ "BufferResponse" , false},
						{ "Timeout" , 20},
						{ "api-key", ""}
					});

					foreach (JObject backend in backends) {
						string saltedUrl = salt + backend["url"].ToString();
						backend["affinity"] = string.Concat(
							System.Security.Cryptography.SHA256.Create()
							.ComputeHash(System.Text.Encoding.UTF8.GetBytes(saltedUrl))
							.Take(10)
							.Select(b => b.ToString("x2"))
						);
						backend["isThrottling"] = false;
						backend["retryAfter"] = DateTime.MinValue;
						backend["defaultRetryAfter"] = 10;
					}
		
					return backends;  
					}" />
				<!-- And store the variable into cache again -->
				<cache-store-value key="@("listBackends-" + context.Api.Id)" value="@((JArray)context.Variables["listBackends"])" duration="60" />
			</when>
		</choose>
		<!--  set the priority to 3 if not set -->
		<set-variable name="RequestPriority" value="@{
			const int defaultPriority = 3;
			string priorityHeaderName = (string)context.Variables["priorityHeaderName"];
			return context.Request.Headers.TryGetValue(priorityHeaderName, out var priorityValues) &&
				int.TryParse(priorityValues.FirstOrDefault(), out int parsedPriority)
				? parsedPriority
				: defaultPriority;
		}" />
		<set-variable name="RequestAffinityBackendIdx" value="@{
			string affinityHeaderName = (string)context.Variables["AffinityHeaderName"];
			string affinityHeader = context.Request.Headers.GetValueOrDefault(affinityHeaderName, "");
					
			// Find the backend with the matching affinity
			if (!string.IsNullOrEmpty(affinityHeader)) {
				JArray backends = (JArray)context.Variables["listBackends"];
				for (int i = 0; i < backends.Count; i++) {
					JObject backend = (JObject)backends[i];
					if (string.Equals(backend["affinity"]?.ToString(), affinityHeader, StringComparison.OrdinalIgnoreCase)) {
						return i;  // Return the index of the matching backend
					}
				}
			}
			
			// Return -1 if no affinity header or no match found
			return -1;
		}" />
		<!-- Get the list of backend indexes that can handle the requested priority -->
		<set-variable name="PriBackendIndxs" value="@{
			JArray list =  new JArray();
			JArray backends = (JArray)context.Variables["listBackends"];
			int requestPriority = (int)context.Variables["RequestPriority"];
			for (int i = 0; i < backends.Count; i++) {
				JObject backend = (JObject)backends[i];
				if (backend["acceptablePriorities"]?.Values<int>().Contains(requestPriority) == true) {
					list.Add(i);
				}
			}
			return list;
		}" />
		<set-variable name="RetryCount" value="@{
			return ((JObject)context.Variables["priorityCfg"])
				.GetValue(context.Variables.GetValueOrDefault<int>("RequestPriority", 3).ToString())?
				.Value<int>("retryCount") ?? 1;
		}" />
		<set-variable name="RequeueAllowed" value="@{
			return ((JObject)context.Variables["priorityCfg"])
				.GetValue(context.Variables.GetValueOrDefault<int>("RequestPriority", 3).ToString())?
				.Value<bool>("requeue") ?? true;
		}" />
		<authentication-managed-identity resource="https://cognitiveservices.azure.com" output-token-variable-name="managed-id-access-token" ignore-error="false" />
		<set-variable name="backendCallCounter" value="@(0)" />
		<set-variable name="PolicyCycleCounter" value="@{
			string policyCycleCounterHeaderName = (string)context.Variables["PolicyCycleCounterHeaderName"];
			return context.Request.Headers.TryGetValue(policyCycleCounterHeaderName, out var priorityValues) &&
				int.TryParse(priorityValues.FirstOrDefault(), out int parsedCounter)   ? parsedCounter : 0;   // return 0 if not set
		}" />
		<!-- set-backend-service base-url="https://a208790-function-app-sleep-gvdha0ffczd4h4cc.eastus2-01.azurewebsites.net/api/sleep_function" />
		<rewrite-uri template="/" copy-unmatched-params="false" /> -->
		<set-variable name="lastPolicyError" value="@{
			// Initialize or reuse
			JArray arr = context.Variables.GetValueOrDefault<JArray>("lastPolicyError", new JArray());
			arr.Clear();
			arr.Add(new JObject {
				{ "code", "init" },
				{ "message", "noError" }
			});
			return arr;
		}" />

		<set-variable name="activityLog" value="@{
			// Initialize or reuse
			JArray arr = context.Variables.GetValueOrDefault<JArray>("activityLog", new JArray());
			arr.Clear();
			arr.Add(new JObject {
				{ "Elapsed", context.Elapsed.TotalSeconds.ToString("F3")},
				{ "message", "Begin" }
			});
			return arr;
		}" />

			
	</inbound>
	<!-- Control if and how the requests are forwarded to services  -->
	<backend>
		<retry condition="@(context.Variables.GetValueOrDefault<bool>("ShouldRetry", true))" count="@(context.Variables.GetValueOrDefault<int>("RetryCount", 20) )" interval="1" delta="1">
			<set-variable name="PolicyCycleCounter" value="@(context.Variables.GetValueOrDefault<int>("PolicyCycleCounter") + 1)" />
			<!-- Before picking the backend, let's verify if there is any that should be set to not throttling anymore -->
			<set-variable name="listBackends" value="@{
				JArray backends = (JArray)context.Variables["listBackends"];

				backends.OfType<JObject>()
					.Where(backend => backend.Value<bool>("isThrottling") && DateTime.UtcNow >= backend.Value<DateTime>("retryAfter"))
					.ToList()
					.ForEach(backend => {
						backend["isThrottling"] = false;
						backend["retryAfter"] = DateTime.MinValue;
					});

				return backends;
			}" />
			<cache-store-value key="@("listBackends-" + context.Api.Id)" value="@((JArray)context.Variables["listBackends"])" duration="60" />

			<!-- If a call was attempted, what scenario are we in?  0: success, 1: error 2: timeout, 3: concurrency limit, 4: unknown -->
			<set-variable name="ErrorScenario" value="@{
				JArray backends = (JArray)context.Variables["listBackends"];
				JArray priorityBackendIndxs = (JArray)context.Variables["PriBackendIndxs"];
				var backendIndex = context.Variables.GetValueOrDefault<int>("backendIndex", -1);
				var arr = context.Variables.GetValueOrDefault<JArray>("activityLog", new JArray());
				var elapsedStr = context.Elapsed.TotalSeconds.ToString("F3");
				var counter = context.Variables.GetValueOrDefault<int>("backendCallCounter", 0);
				if ( backendIndex < 0 || backendIndex >= backends.Count) {

					if ( counter > 0 ) {
						arr.Add(new JObject {{ "Elapsed", elapsedStr },{ "message", $"Invalid backend index: {backendIndex}" }});
					} else {
						string msg = $"BACKENDS:";

						foreach (int i in priorityBackendIndxs) {
							JObject b = (JObject)backends[i];
							var delta =  Math.Min(0, (DateTime.UtcNow - b.Value<DateTime>("retryAfter")).TotalSeconds);
							msg += " ["+i+"]=IsThrottling=" + b.Value<bool>("isThrottling") + " RetryAfter=" + delta.ToString("F3");
						}

						arr.Add(new JObject {{ "Elapsed", context.Elapsed.TotalSeconds.ToString("F3") },{ "message", msg }});
					}
					return 4; // unknown
				}

				var lastStatusCode = context.Response?.StatusCode ?? 0;
				var callCompleted = context.Variables.GetValueOrDefault<bool>("callCompleted", true);
				var wasLimited = context.Variables.GetValueOrDefault<bool>("wasLimited", false);
				var startTime = context.Variables.GetValueOrDefault<DateTime>("CallAttemptStartTime", DateTime.UtcNow);
				var deltaSeconds = (DateTime.UtcNow - startTime).TotalSeconds;
				var requestTimeout = ((JObject)backends[backendIndex]).Value<int>("Timeout");
				bool likelyTimeout = deltaSeconds >= (requestTimeout * 0.9);

				JObject backend = (JObject)backends[backendIndex];

				if ( callCompleted ) {
					if (lastStatusCode==200) {
						return 0; // success
					} else {
						return 1; // error
					}
				} else if ( likelyTimeout) {
					arr.Add(new JObject {{ "Elapsed", elapsedStr },{ "message", $"Throttling [{backendIndex}] by 10s, likely timeout Elapsed: {deltaSeconds:F1}s Timeout: {requestTimeout}s" }});
					backend["isThrottling"] = true;
					backend["retryAfter"] = DateTime.UtcNow.AddSeconds(10);
					return 2; // timeout
				} else if ( wasLimited ) {
					arr.Add(new JObject {{ "Elapsed", elapsedStr },{ "message", $"Throttling [{backendIndex}] by 10s due to concurrency limit" }});
					backend["isThrottling"] = true;
					backend["retryAfter"] = DateTime.UtcNow.AddSeconds(10);
					return 3; // concurrency limit
				} else {
					arr.Add(new JObject {{ "Elapsed", elapsedStr },{ "message", $"Error status {lastStatusCode} after {deltaSeconds:F1}s" }});
					return 4; // unknown
				}
			}" />

			<!-- This is the main logic to pick the backend to be used -->
			<set-variable name="backendIndex" value="@{
				try {

				// Retrieve the list of backends
				JArray backends = context.Variables.GetValueOrDefault<JArray>("listBackends", new JArray());
				if (!backends.Any()) {return -1;}

				JArray priorityBackendIndxs = (JArray)context.Variables["PriBackendIndxs"];
				int backendCallCount = context.Variables.GetValueOrDefault<int>("backendCallCounter", 0);
				
				// Only check backend affinity on the first call
				if (backendCallCount == 0) {
					int affinityBackendIdx = context.Variables.GetValueOrDefault<int>("RequestAffinityBackendIdx", -1);

					// Check if we have a valid affinity backend and it's in our priority list
					if (affinityBackendIdx != -1 ) {
						JObject backend = (JObject)backends[affinityBackendIdx];
						// Only use the affinity backend if it's not throttling
						if (!backend.Value<bool>("isThrottling")) {
							return affinityBackendIdx;
						}
					}
				}

				// If no affinity match found or not the first call, proceed with normal selection
				// Find all non-throttling backends that support the request priority
				var availableBackends = new List<int>();
				int lowestPriority = int.MaxValue;
				
				// Find the lowest priority available backends
				foreach (int i in priorityBackendIndxs) {
					JObject backend = (JObject)backends[i];
					if (!backend.Value<bool>("isThrottling")) {
						int priority = backend.Value<int>("priority");
						if (priority < lowestPriority) {
							lowestPriority = priority;
							availableBackends.Clear();
							availableBackends.Add(i);  // Store the index instead of the backend object
						} else if (priority == lowestPriority) {
							availableBackends.Add(i);  // Store the index instead of the backend object
						}
					}
				}

				if (!availableBackends.Any())  { return -1; }

				// pick a random backend from the available ones
				return availableBackends[ new Random(context.RequestId.GetHashCode()).Next(availableBackends.Count) ];

				} catch (Exception ex) {
					// Grab existing single-element error array (created in inbound)
					var errArr = context.Variables.GetValueOrDefault<JArray>("lastPolicyError", null);
					  if (errArr != null) {
						errArr.Clear();
						var msg = ex.Message ?? "Exception has no Message";
						if (msg.Length > 300) {
							msg = msg.Substring(0, 300) + "...";
						}
						errArr.Add(new JObject {
							{ "code", "backendIndex-update" },
							{ "message", msg },
							{ "utc", DateTime.UtcNow.ToString("o") }
						});
					}

					return -1;
				}


			}" />
			<set-variable name="shouldLimit" value="@{
				try {
				// Check if the backend should limit concurrency
				JArray backends = context.Variables.GetValueOrDefault<JArray>("listBackends", new JArray());
				int backendIndex = (int)context.Variables["backendIndex"];
				if (backendIndex < 0 || backendIndex >= backends.Count) { return "off"; }
				JObject backend = (JObject)backends[backendIndex];
				return backend.Value<string>("LimitConcurrency");
				} catch (Exception ex) {
					var errArr = context.Variables.GetValueOrDefault<JArray>("lastPolicyError", null);
					if (errArr != null) {
						errArr.Clear();
						var msg = ex.Message ?? "Exception has no Message";
						if (msg.Length > 300) { msg = msg.Substring(0,300) + "..."; }
						errArr.Add(new JObject {
							{ "code", "shouldLimit-update" },
							{ "message", msg },
							{ "utc", DateTime.UtcNow.ToString("o") }
						});
					}
					return "off";
				}
			}" />
			<!-- Make the request to the selected backend -->
			<set-variable name="activityLog" value="@{
				var arr = context.Variables.GetValueOrDefault<JArray>("activityLog", new JArray());
				arr.Add(new JObject {
					{ "Elapsed", context.Elapsed.TotalSeconds.ToString("F3")},
					{ "message", "RETRIES: " + (1+context.Variables.GetValueOrDefault<int>("RetryCount")) + 
								" CYCLE: " + context.Variables.GetValueOrDefault<int>("PolicyCycleCounter") + 
								" INDEX: " + context.Variables.GetValueOrDefault<int>("backendIndex") +
								" LIMIT: " + context.Variables.GetValueOrDefault<string>("shouldLimit", "off") }
				});
				return arr;
			}" />

			<!-- Ok to make a request -->
			<set-variable name="callAttempted" value="@(false)" />
			<choose>
				<when condition="@(context.Variables.GetValueOrDefault<int>("backendIndex", 0) > -1 && context.Variables.GetValueOrDefault<int>("RetryCount") >= 0)">
					<!-- Set each backend configuration value individually -->
					<set-variable name="RetryCount" value="@(context.Variables.GetValueOrDefault<int>("RetryCount") - 1)" />
					<set-variable name="selectedBackend" value="@(((JArray)context.Variables["listBackends"])[(int)context.Variables["backendIndex"]])" />
					<set-variable name="RequestTimeout" value="@(((JObject)context.Variables["selectedBackend"]).Value<int>("Timeout"))" />										
					<set-variable name="backendUrl" value="@(((JObject)context.Variables["selectedBackend"]).Value<string>("url") + "/openai")" />
					<set-variable name="api-key" value="@(((JObject)context.Variables["selectedBackend"]).Value<string>("api-key"))" />
					<set-variable name="backendCallCounter" value="@(context.Variables.GetValueOrDefault<int>("backendCallCounter") + 1)" />
					<!-- Set the backend service URL -->
					<set-backend-service base-url="@((string)context.Variables["backendUrl"])" />
					<!-- use Managed Identity or the API-Key -->
					<choose>
						<when condition="@(context.Variables.GetValueOrDefault<string>("api-key", "") != "")">
							<set-header name="api-key" exists-action="override">
								<value>@((string)context.Variables["api-key"])</value>
							</set-header>
						</when>
						<otherwise>
							<set-header name="Authorization" exists-action="override">
								<value>@("Bearer " + (string)context.Variables["managed-id-access-token"])</value>
							</set-header>
						</otherwise>
					</choose>
					<set-variable name="activityLog" value="@{
						var arr = context.Variables.GetValueOrDefault<JArray>("activityLog", new JArray());
						int index = context.Variables.GetValueOrDefault<int>("backendIndex", 0);
						JObject backend = (JObject)((JArray)context.Variables["listBackends"])[index];
						arr.Add(new JObject {
							{ "Elapsed", context.Elapsed.TotalSeconds.ToString("F3") },
							{ "message", "Using " + backend.Value<string>("ModelType") + " backend: " + backend.Value<string>("url") }
						});
						return arr;
					}" />
					<!-- If the endpoint is concurrency limited, it will immedietly retry -->

					<set-variable name="callCompleted" value="@(false)" />
					<set-variable name="callAttempted" value="@(true)" />
					<set-variable name="CallAttemptStartTime" value="@(DateTime.UtcNow)" />
					<set-variable name="wasLimited" value="@(true)" />
					<choose>
						<when condition="@(((JObject)context.Variables["selectedBackend"]).Value<bool>("BufferResponse"))">
							<choose>
								<when condition="@(context.Variables.GetValueOrDefault<string>("shouldLimit", "off") == "low")">
									<limit-concurrency key="PTU" max-count="10">
										<forward-request buffer-request-body="true" buffer-response="true" timeout="@((int)context.Variables["RequestTimeout"])"/>
									</limit-concurrency>
								</when>
								<when condition="@(context.Variables.GetValueOrDefault<string>("shouldLimit", "off") == "medium")">
									<limit-concurrency key="PTU" max-count="50">
										<forward-request buffer-request-body="true" buffer-response="true" timeout="@((int)context.Variables["RequestTimeout"])" />
									</limit-concurrency>
								</when>
								<when condition="@(context.Variables.GetValueOrDefault<string>("shouldLimit", "off") == "high")">
									<limit-concurrency key="PTU" max-count="100">
										<forward-request buffer-request-body="true" buffer-response="true" timeout="@((int)context.Variables["RequestTimeout"])" />
									</limit-concurrency>
								</when>
								<otherwise>
									<set-variable name="wasLimited" value="@(false)" />
										<forward-request buffer-request-body="true" buffer-response="true" timeout="@((int)context.Variables["RequestTimeout"])" />
								</otherwise>
							</choose>
						</when>
						<otherwise>
							<choose>
								<when condition="@(context.Variables.GetValueOrDefault<string>("shouldLimit", "off") == "low")">
									<limit-concurrency key="PTU" max-count="10">
										<forward-request buffer-request-body="true" buffer-response="false" timeout="@((int)context.Variables["RequestTimeout"])"/>
									</limit-concurrency>
								</when>
								<when condition="@(context.Variables.GetValueOrDefault<string>("shouldLimit", "off") == "medium")">
									<limit-concurrency key="PTU" max-count="50">
										<forward-request buffer-request-body="true" buffer-response="false" timeout="@((int)context.Variables["RequestTimeout"])" />
									</limit-concurrency>
								</when>
								<when condition="@(context.Variables.GetValueOrDefault<string>("shouldLimit", "off") == "high")">
									<limit-concurrency key="PTU" max-count="100">
										<forward-request buffer-request-body="true" buffer-response="false" timeout="@((int)context.Variables["RequestTimeout"])" />
									</limit-concurrency>
								</when>
								<otherwise>
									<set-variable name="wasLimited" value="@(false)" />
										<forward-request buffer-request-body="true" buffer-response="false" timeout="@((int)context.Variables["RequestTimeout"])" />
								</otherwise>
							</choose>
						</otherwise>
					</choose>
					<set-variable name="wasLimited" value="@(false)" />
					<set-variable name="callCompleted" value="@(true)" />

					<!-- Temporary Errors:  408, 429 and 50xx  -->
					<set-variable name="isTempError" value="@{
						var statusCode = context.Response?.StatusCode ?? 500;

						bool isTempError = statusCode == 429 || statusCode == 408 || statusCode == 400 || statusCode >= 500;
						return isTempError;
					}" />
					<!-- Permanent Errors:  >400 , !408, !429 , <500   -->
					<set-variable name="isPermError" value="@{
						var isTempError = context.Variables.GetValueOrDefault<bool>("isTempError", false);
						var statusCode = context.Response?.StatusCode ?? 500;
						bool isPermError =  !isTempError && (statusCode > 400 && statusCode < 500);
						return isPermError;
					}" />
					<set-variable name="activityLog" value="@{
						var arr = context.Variables.GetValueOrDefault<JArray>("activityLog", new JArray());
						arr.Add(new JObject {
							{ "Elapsed", context.Elapsed.TotalSeconds.ToString("F3") },
							{ "message", "ATTEMPT SUMMARY-  isPermError: " + context.Variables.GetValueOrDefault<bool>("isPermError", false) +
								" isTempError: " + context.Variables.GetValueOrDefault<bool>("isTempError", false) +
								" StatusCode: " + (context.Response?.StatusCode.ToString() ?? "N/A") }
						});
						return arr;
					}" />
				</when>
			</choose>
			
			<choose>
				<when condition="@(context.Variables.GetValueOrDefault<bool>("isTempError", true) )">
					<cache-lookup-value key="@("listBackends-" + context.Api.Id)" variable-name="listBackends" />
					<set-variable name="listBackends" value="@{
						JArray backends = (JArray)context.Variables["listBackends"];
						int currentBackendIndex = (int)context.Variables["backendIndex"];

						// Validate backend index
						if (currentBackendIndex < 0 || currentBackendIndex >= backends.Count) {
							return backends; // Return unchanged if index is invalid
						}

						JObject backend = (JObject)backends[currentBackendIndex];

						// Attempt to retrieve retry-after duration from headers
						string[] retryHeaders = new[] { "retry-after" };
						int retryAfterSeconds = backend["defaultRetryAfter"].Value<int>(); 

						foreach (string headerName in retryHeaders) {

							if (context.Response.Headers.Keys.Any(k => string.Equals(k, headerName, StringComparison.OrdinalIgnoreCase))){
								string headerValue = context.Response.Headers[headerName].FirstOrDefault();

								if (int.TryParse(headerValue, out int parsedValue) && parsedValue > 0)
								{
									retryAfterSeconds = parsedValue + 2;
									break;
								}
							}
						}

						// Update backend status
						backend["isThrottling"] = true;

						// we're multi-processing, so we need to set the retryAfter to the max of the current and the new one
						var newRetryAfter = DateTime.UtcNow.AddSeconds(retryAfterSeconds);
						if (newRetryAfter > backend["retryAfter"].Value<DateTime>()) {
							backend["retryAfter"] = newRetryAfter;
						}

						return backends;	 
					}" />
					<cache-store-value key="@("listBackends-" + context.Api.Id)" value="@((JArray)context.Variables["listBackends"])" duration="60" />
				</when>
			</choose>
			<set-variable name="unThrottledBackends" value="@{
				var backends = context.Variables.GetValueOrDefault<JArray>("listBackends", new JArray());
				var priorityBackendIndxs = (JArray)context.Variables["PriBackendIndxs"];
				int count=0;
				foreach (int i in priorityBackendIndxs) {
					JObject backend = (JObject)backends[i];
					if (!backend.Value<bool>("isThrottling")) {
						count++;
					}
				}
				return count;
			}" />
			<set-variable name="ShouldRetry" value="@{
				var isPermError = context.Variables.GetValueOrDefault<bool>("isPermError", false);
				var retryCount = context.Variables.GetValueOrDefault<int>("RetryCount", -1);
				var unthrottled = context.Variables.GetValueOrDefault<int>("unThrottledBackends", 0);
				var RequeueAllowed = context.Variables.GetValueOrDefault<bool>("RequeueAllowed", true);
				var proxyRequeue = RequeueAllowed && (unthrottled == 0);

				return (!isPermError && retryCount >= 0) && !proxyRequeue;
			}" />

			<set-variable name="ShouldRequeue" value="@{
				var isPermError = context.Variables.GetValueOrDefault<bool>("isPermError", false);
				var ShouldRetry = context.Variables.GetValueOrDefault<bool>("ShouldRetry", true);
				var RequeueAllowed = context.Variables.GetValueOrDefault<bool>("RequeueAllowed", true);

				return !isPermError && RequeueAllowed && !ShouldRetry;
			}" />

			<set-variable name="activityLog" value="@{
				var arr = context.Variables.GetValueOrDefault<JArray>("activityLog", new JArray());
				var ShouldRetry = context.Variables.GetValueOrDefault<bool>("ShouldRetry", true);
				var ShouldRequeue = context.Variables.GetValueOrDefault<bool>("ShouldRequeue", true);
				var count = context.Variables.GetValueOrDefault<int>("unThrottledBackends", 0);
				var callCompleted = context.Variables.GetValueOrDefault<bool>("callCompleted", false);
				var status = (context.Response != null && context.Response.StatusCode == 200);

				if ( callCompleted && status ) {
					arr.Add(new JObject {{ "Elapsed", context.Elapsed.TotalSeconds.ToString("F3") },{ "message", "CALL SUCCESSFUL" }});
				} else {
					arr.Add(new JObject {
						{ "Elapsed", context.Elapsed.TotalSeconds.ToString("F3") },
						{ "message", "CALCULATED :-- SHOULD RETRY: " + ShouldRetry + " REQUEUE: " + ShouldRequeue +
							" UnthrottledBackends: " + count }
					});
				}
				return arr;
			}" />

			<!-- Determine if next action is retry, requeue, or return response -->
			<choose>
				<!-- If we got a 200, skip the retry and return the response -->
				<when condition="@(context.Variables.GetValueOrDefault<bool>("callCompleted", false) && context.Response != null && context.Response.StatusCode == 200)">
					<set-variable name="ShouldRetry" value="@(false)" />
				</when>

				<!-- If all backends are throttling, calculate sleep time and return a 429 -->
				<when condition="@(context.Variables.GetValueOrDefault<bool>("ShouldRequeue", true))">
					<set-variable name="ShouldRetry" value="@(false)" />
					<set-variable name="sleepDuration" value="@{

						JArray backends = context.Variables.GetValueOrDefault<JArray>("listBackends", new JArray());
						JArray priorityBackendIndxs = (JArray)context.Variables["PriBackendIndxs"];
						DateTime minRetryTime  = DateTime.MaxValue;

						foreach (int i in priorityBackendIndxs) {
							if (backends[i].Value<bool>("isThrottling") && backends[i].Value<DateTime>("retryAfter") < minRetryTime) {
								minRetryTime = backends[i].Value<DateTime>("retryAfter");
							}
						}

						if (minRetryTime > DateTime.UtcNow)  {
							return (int)Math.Min(120000,  (minRetryTime - DateTime.UtcNow).TotalMilliseconds);
						}

						return 1000;
					}" />
					<!--<set-variable name="activityLog" value="@{
						JArray arr = context.Variables.GetValueOrDefault<JArray>("activityLog", new JArray());
						arr.Add(new JObject {
							{ "Elapsed", context.Elapsed.TotalSeconds.ToString("F3")},
							{ "message", "No available backends" }
						});
						return arr;
					}" />
					<send-request mode="new" response-variable-name="sleepResponse" timeout="@(Math.Min(10, (int)Math.Ceiling(((double)context.Variables["sleepDuration"])/1000) + 1))">
						<set-url>@("https://your-backend-service/sleep?milliseconds=" + context.Variables["sleepDuration"])</set-url>
						<set-method>GET</set-method>
					</send-request>
					-->
					<return-response>
						<set-status code="429" reason="Requeue Message" />
						<set-header name="X-Policy-LastError" exists-action="override">
							<value>@{
								JArray errArr = context.Variables.GetValueOrDefault<JArray>("lastPolicyError", new JArray());
								return errArr.Count == 0 ? "" : errArr.ToString(Newtonsoft.Json.Formatting.None);
							}</value>
						</set-header>
						<set-header name="S7PREQUEUE" exists-action="override">
							<value>true</value>
						</set-header>
						<set-header name="retry-after-ms" exists-action="override">
							<value>@(context.Variables.GetValueOrDefault<int>("sleepDuration",10000).ToString())</value>
						</set-header>
						<set-header name="x-Backend-Attempts" exists-action="override">
							<value>@(context.Variables.GetValueOrDefault<int>("backendCallCounter", 0).ToString())</value>
						</set-header>
						<set-header name="@((string)context.Variables["PolicyCycleCounterHeaderName"])" exists-action="override">
							<value>@(context.Variables.GetValueOrDefault<int>("PolicyCycleCounter", 0).ToString())</value>
						</set-header>
						<set-header name="backendLog" exists-action="override">
							<value>@{
								JArray actLog = context.Variables.GetValueOrDefault<JArray>("activityLog", new JArray());
								string result = string.Join(" | ", actLog.Select(entry => 
									((JObject)entry).Value<string>("Elapsed") + "s " + ((JObject)entry).Value<string>("message")
								));
								return result.Length > 4000 ? result.Substring(0, 4000) + "..." : result;
							}</value>
						</set-header>
					</return-response>
				</when>

				<!-- If we got a permanent error, return the error code -->
				<when condition="@(context.Variables.GetValueOrDefault<bool>("isPermError", true))">
					<return-response>
						<set-status code="@(context.Response?.StatusCode ?? 500)" reason="Permanent Error" />
						<set-header name="x-Backend-Attempts" exists-action="override">
							<value>@(context.Variables.GetValueOrDefault<int>("backendCallCounter", 0).ToString())</value>
						</set-header>
						<set-header name="@((string)context.Variables["PolicyCycleCounterHeaderName"])" exists-action="override">
							<value>@(context.Variables.GetValueOrDefault<int>("PolicyCycleCounter", 0).ToString())</value>
						</set-header>
						<set-header name="backendLog" exists-action="override">
							<value>@{
								JArray actLog = context.Variables.GetValueOrDefault<JArray>("activityLog", new JArray());
								string result = string.Join(" | ", actLog.Select(entry => 
									((JObject)entry).Value<string>("Elapsed") + " " + ((JObject)entry).Value<string>("message")
								));
								return result.Length > 4000 ? result.Substring(0, 4000) + "..." : result;
							}</value>
						</set-header>
					</return-response>
				</when>

				<!-- Continue retrying -->
				<when condition="@(context.Variables.GetValueOrDefault<int>("RetryCount") > 0)">
					<set-variable name="activityLog" value="@{
						var arr = context.Variables.GetValueOrDefault<JArray>("activityLog", new JArray());
						arr.Add(new JObject {{ "Elapsed", context.Elapsed.TotalSeconds.ToString("F3") },{ "message", "Retrying..." }});
						return arr;
					}" />
				</when>
			</choose>
		</retry>
	</backend>
	<!-- Customize the responses -->
	<outbound>
		<base />
		<set-header name="TOKENPROCESSOR" exists-action="override">
			<value>MultiLineAllUsage</value>
		</set-header>
		<set-header name="@((string)context.Variables["AffinityHeaderName"])" exists-action="override">
			<value>@(((JObject)context.Variables["selectedBackend"]).Value<string>("affinity"))</value>
		</set-header>
		<set-header name="x-Backend-Attempts" exists-action="override">
			<value>@(context.Variables.GetValueOrDefault<int>("backendCallCounter", 0).ToString())</value>
		</set-header>
		<set-header name="@((string)context.Variables["PolicyCycleCounterHeaderName"])" exists-action="override">
			<value>@(context.Variables.GetValueOrDefault<int>("PolicyCycleCounter", 0).ToString())</value>
		</set-header>
		<set-header name="backendLog" exists-action="override">
			<value>@{
				JArray actLog = context.Variables.GetValueOrDefault<JArray>("activityLog", new JArray());
				string result = string.Join(" | ", actLog.Select(entry => 
					((JObject)entry).Value<string>("Elapsed") + "s " + ((JObject)entry).Value<string>("message")
				));
				return result.Length > 4000 ? result.Substring(0, 4000) + "..." : result;
			}</value>
		</set-header>
		<set-header name="X-Policy-LastError" exists-action="override">
			<value>@{
				JArray errArr = context.Variables.GetValueOrDefault<JArray>("lastPolicyError", new JArray());
				return errArr.Count == 0 ? "" : errArr.ToString(Newtonsoft.Json.Formatting.None);
			}</value>
		</set-header>
		<!-- <include-fragment fragment-id="LogResponseFragment" /> -->
	</outbound>
	<!-- Handle exceptions and customize error responses  -->
	<on-error>
		<set-variable name="responseObject" value="@{
			var responseObj = context.Variables.GetValueOrDefault<JObject>("responseObject", new JObject());
			var arr = context.Variables.GetValueOrDefault<JArray>("activityLog", new JArray());
			var statusCode = context.Response?.StatusCode ?? 500;
			var callCompleted = context.Variables.GetValueOrDefault<bool>("callCompleted", false);
			var backendIndex = context.Variables.GetValueOrDefault<int>("backendIndex", -1);

			bool isTempError = statusCode == 429 || statusCode == 408 || statusCode == 400 || statusCode >= 500;
			bool isPermError = false;//!isTempError && (statusCode > 400 && statusCode < 500);

			if (callCompleted) {
				if (isPermError) {
					responseObj["statusCode"] = statusCode;
					responseObj["statusReason"] = "Permanent Error";
				} else if (isTempError) {
					responseObj["statusCode"] = statusCode;
					responseObj["statusReason"] = "Temporary Error";
				} else {
					responseObj["statusCode"] = 500;
					responseObj["statusReason"] = "Unknown Error";
				}
			} else {
				JArray backends = (JArray)context.Variables["listBackends"];

				if ( backendIndex < 0 || backendIndex >= backends.Count) {
					responseObj["statusCode"] = 500;
					responseObj["statusReason"] = "Invalid Backend Index";
					return responseObj;
				}

				// recalculate timeout or concurrency limit because retry did not happen
				var wasLimited = context.Variables.GetValueOrDefault<bool>("wasLimited", false);
				var startTime = context.Variables.GetValueOrDefault<DateTime>("CallAttemptStartTime", DateTime.UtcNow);
				var deltaSeconds = (DateTime.UtcNow - startTime).TotalSeconds;
				var requestTimeout = ((JObject)backends[backendIndex]).Value<int>("Timeout");
				bool likelyTimeout = deltaSeconds >= (requestTimeout * 0.9);

				if ( likelyTimeout) {
					responseObj["statusCode"] = 408;
					responseObj["statusReason"] = "Timeout";
					statusCode = 408;
				} else if ( wasLimited ) {
					responseObj["statusCode"] = 429;
					responseObj["statusReason"] = "Concurrency Limit";
					statusCode = 429;
				} else {
					responseObj["statusCode"] = 500;
					responseObj["statusReason"] = "Unknown Error";
				}
			}

			arr.Add(new JObject {
				{ "Elapsed", context.Elapsed.TotalSeconds.ToString("F3") },
				{ "message", "ON ERROR HANDLER INVOKED-  callCompleted: " + callCompleted +
					" isPermError: " + isPermError +
					" isTempError: " + isTempError +
					" StatusCode: " + statusCode }
			});
			return responseObj;
		}" />
		<set-status code="@(((JObject)context.Variables["responseObject"]).Value<int>("statusCode"))" 
			reason="@(((JObject)context.Variables["responseObject"]).Value<string>("statusReason"))" />
		<!-- set the body	-->
		<set-body>@{
			var responseObj = context.Variables.GetValueOrDefault<JObject>("responseObject", new JObject());
			return responseObj.ToString(Newtonsoft.Json.Formatting.None);
		}</set-body>
		<set-header name="backendLog" exists-action="override">
			<value>@{
				JArray actLog = context.Variables.GetValueOrDefault<JArray>("activityLog", new JArray());
				string result = string.Join(" | ", actLog.Select(entry => 
					((JObject)entry).Value<string>("Elapsed") + "s " + ((JObject)entry).Value<string>("message")
				));
				return result.Length > 4000 ? result.Substring(0, 4000) + "..." : result;
			}</value>
		</set-header>
		<set-header name="X-Policy-LastError" exists-action="override">
			<value>@{
				JArray errArr = context.Variables.GetValueOrDefault<JArray>("lastPolicyError", new JArray());
				return errArr.Count == 0 ? "" : errArr.ToString(Newtonsoft.Json.Formatting.None);
			}</value>
		</set-header>
		<base />
	</on-error>
</policies>